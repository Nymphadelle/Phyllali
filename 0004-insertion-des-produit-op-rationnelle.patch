From 12e7a7c7cc971c5b4372aeb18da986cefa5b7e29 Mon Sep 17 00:00:00 2001
From: a <a>
Date: Mon, 9 Dec 2013 23:56:56 +0100
Subject: [PATCH 4/4] =?UTF-8?q?insertion=20des=20produit=20op=C3=A9rationn?=
 =?UTF-8?q?elle?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 Classes/Produit.php     | 32 ++++++++------------------------
 Resources/javascript.js | 41 +++++++++++++++++++++++++++++++++++++----
 ajax/ajouterproduit.php | 10 ++++------
 index.php               |  3 +--
 4 files changed, 50 insertions(+), 36 deletions(-)

diff --git a/Classes/Produit.php b/Classes/Produit.php
index e073b17..e410ba6 100644
--- a/Classes/Produit.php
+++ b/Classes/Produit.php
@@ -6,32 +6,16 @@ require_once 'Connect.php';
 class Produit extends Connect{
 
 	public function insertProduct($cat,$user,$libelle,$description,$etat,$delai,$photo){
-		/* $sql = "SELECT ID_VILLE FROM VILLE WHERE NOM_VILLE='".strtoupper($ville)."' AND CODE_POSTAL_=".$cp."";
-		$ret = $this->executerRequete($sql);
-		$indiceVille = odbc_result($ret,'ID_VILLE');
-		
-		// si la ville n'existe pas on insère
-		if ( $indiceVille == '' ) {
-			// on insère 
-			$sql = "INSERT INTO VILLE(NOM_VILLE,CODE_POSTAL_) VALUES ('".strtoupper($ville)."', ".$cp.");";
-			$this->executerRequete($sql);
-			// obtenir le max de l'indice actuel
-			$sql = "SELECT MAX(ID_VILLE) as ID FROM VILLE";
-			$ret = $this->executerRequete($sql);
-			$indiceVille = odbc_result($ret,'ID');
-		}
-		 */
-		// on insère l'utilisateur
+		// on insère le nouveau produit
+		$sql = "INSERT INTO PRODUIT (ID_CATEGORIE,UTIL_ID,LIBELLE_PDT,DESCRIPTION,DATE_FIN,ETAT,PHOTO_PDT) VALUES (".$cat.",".$user.",'".$libelle."','".$description."',dateadd(hh,".$delai.",getdate()),'".$etat."','".$photo."') SELECT @@identity AS ID;";
+
+		$res = $this->executerRequete($sql);
+		//on récupère l'id du produit inséré
+		$id_prod = odbc_result($res,'ID');
 		
-		$sql = "INSERT INTO PORDUIT (ID_CATEGORIE,UTIL_ID,LIBELLE_PDT,DESCRIPTION,DATE_FIN,ETAT,PHOTO_PDT) VALUES (".$cat.",".$user.",'".$libelle."','".$description."','now()','".$etat."','".$photo."');";
+		//on l'insère ensuite dans les produits actifs
+		$sql = "INSERT INTO PRODUIT_ACTIF (PDT_ID,UTIL_ID) VALUES (".$id_prod.",".$user.");";
 		$this->executerRequete($sql);
-		//$sql = "SELECT MAX(UTIL_ID) as ID FROM UTILISATEUR";
-		//$ret = $this->executerRequete($sql);
-		//$indiceUtil = odbc_result($ret,'ID');
-		
-		// on insère ses identifiants de connexion
-		//$sql = "INSERT INTO CONNEXION (mail,mdp,util) VALUES ('".$mail."','".$mdp."',".$indiceUtil.");";
-		//$this->executerRequete($sql);
 	}
 	
 	//renvoie la liste des produits
diff --git a/Resources/javascript.js b/Resources/javascript.js
index d353270..adff410 100644
--- a/Resources/javascript.js
+++ b/Resources/javascript.js
@@ -52,6 +52,27 @@ function validerProfil() {
   });
 }
 
+function ajoutProduit() {
+	$.ajax({
+  type: "POST",
+  url: "ajax/ajouterproduit.php"
+})
+  .done(function( html ) {
+		$( "#presentation" ).html(html);
+  });
+}
+
+function insererProduit() {
+	$.ajax({
+  type: "POST",
+  url: "ajax/insererproduit.php",
+  data: { libelle: $("#libelle").val(), cat: $("#cat").val(), description: $("#description").val(), etat: $("#etat").val(), delai: $("input[name=delai]:checked").val(), photo: $("#photo").val()}
+})
+  .done(function( html ) {
+		$( "#presentation" ).html(html);
+  });
+}
+
 //////////////////////////////////////////
 //////////////// HANDLERS ////////////////
 //////////////////////////////////////////
@@ -130,6 +151,21 @@ $('html').on('click', '#valider_souhait', function(event){
 	});
 });
 
+// handler sur le bouton ajouter un produit
+$('body').on('click', '#ajouter', function(event){
+	// on annule le comportemet par dÃ©faut de l'ancre
+	event.preventDefault();
+	ajoutProduit();
+	
+});
+
+$('html').on('click', '#valider_objet', function(event){
+	// on annule le comportemet par dÃ©faut de l'ancre
+	
+	event.preventDefault();
+	insererProduit();
+	
+});
 
 // bouton connexion
 $("#connexion").unbind().click(function(event) {
@@ -147,14 +183,11 @@ $("#connexion").unbind().click(function(event) {
 		}
 		console.log('maj html');
 		$('#compte').html('Bonjour, '+html);
-		$("<div id='picto'><a id='modpro' title='Modifier profil'> M </a><a title='Ajouter produit'> A </a><a id='listeSouhaits' title='Liste de souhaits'> S </a></div>").insertAfter('#compte');
+		$("<div id='picto'><a id='modpro' title='Modifier profil'> M </a><a id='ajouter' title='Ajouter produit'> A </a><a id='listeSouhaits' title='Liste de souhaits'> S </a></div>").insertAfter('#compte');
 		$('#buttons').html('<form method="POST" action="ajax/decoclient.php"><input type="submit" id="deconnexion" value="DÃ©connexion"></form>');
 	});
 });
 
-
-
-
 $(".vignette").click(function() {
 // appel de la page afficheProduit.php
  	$.ajax({
diff --git a/ajax/ajouterproduit.php b/ajax/ajouterproduit.php
index 0acfa40..d1e0fd2 100644
--- a/ajax/ajouterproduit.php
+++ b/ajax/ajouterproduit.php
@@ -21,10 +21,8 @@ require_once '../Classes/Categorie.php';
 				$tab_cat = array();
 				$tab_cat = $cat->getCategories();
 				
-				
 				foreach($tab_cat as $row){
-					//print_r($row);
-					echo '<option value="'.$row['ID_CATEGORIE'].'">'.$row['NOM_CATEG'].'</option>';
+					echo '<option id="'.$row['ID_CATEGORIE'].'">'.$row['NOM_CATEG'].'</option>';
 					
 					//on affiche les sous catégories directement sous leur catégorie
 					$tab_scat = array();
@@ -56,9 +54,9 @@ require_once '../Classes/Categorie.php';
 		<TR>
 			<TD>Choix d&eacute;lai d'activit&eacute;</TD>
 			<TD>
-			<INPUT type=radio id="delai" value="12"><label>12 heures</label>
-			<INPUT type=radio id="delai" value="24" checked><label>24 heures</label>
-			<INPUT type=radio id="delai" value="48"><label>48 heures</label>
+			<INPUT type=radio id="delai12" name="delai" value="12" checked><label>12 heures</label>
+			<INPUT type=radio id="delai24" name="delai" value="24"><label>24 heures</label>
+			<INPUT type=radio id="delai48" name="delai" value="48"><label>48 heures</label>
 			</TD>
 		</TR>
 		
diff --git a/index.php b/index.php
index 1cd6e32..a001c12 100644
--- a/index.php
+++ b/index.php
@@ -34,11 +34,10 @@ $produits = $donnees->getProduits();
 			echo "</div>";
 			echo "<div id='picto'>";
 			echo "<a id='modpro' title='Modifier profil'> M </a>";
-			echo "<a title='Ajouter produit'> A </a>";
+			echo "<a id='ajouter' title='Ajouter produit'> A </a>";
 			echo "<a id='listeSouhaits' title='Liste de souhaits'> S </a>";
 			echo "</div>";
 			echo "<div id='buttons'>";
-			echo "<form method='POST' action ='#'><input type='submit' id='ajouter' value='+'></form><br>";
 			echo "<form method='POST' action ='ajax/decoclient.php'><input type='submit' id='deconnexion' value='Déconnexion'></form>";
 			echo "</div>";
 
-- 
1.8.4.msysgit.0

